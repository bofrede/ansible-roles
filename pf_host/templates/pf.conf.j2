####################################################################################################
### THIS pf.conf IS MANAGED BY ANSIBLE, CHANGES WILL BE OVERWRITTEN!
####################################################################################################

####################################################################################################
################ options ###############################
set limit states 500000 # increased from default 10000
set limit frags 100000 # increased frm default 5000
set block-policy drop


####################################################################################################
################ macros ################################
{% for interface in network_interfaces %}
{% if interface.vlan is defined %}
{{ interface.pf_macro }}="{{ interface.interface }}.{{ interface.vlan }}"
{% else %}
{{ interface.pf_macro }}="{{ interface.interface }}"
{% endif %}
{% endfor %}

################ common/shared address macros ###############
{{ pf_common_address_macros | default("# No common macros found") }}

################ macros specific to {{ ansible_nodename }} #######################
{{ pf_local_address_macros | default("# No local macros found") }}


###################################################################################################
############### scrubbing ##############################
{% for interface in network_interfaces %}
{% if interface.pf_scrub %}
scrub in on ${{ interface.pf_macro }} all fragment reassemble
{% endif %}
{% endfor %}

############### outgoing translation NAT #################
{{ pf_nat_rules | default("# No NAT rules found") }}

############### incoming translation RDR ########################
{{ pf_rdr_rules | default("# No RDR rules found") }}


####################################################################################################
############### filtering ##############################
### block everything
block log all

### skip loopback interface(s)
set skip on lo0

{% for interface in network_interfaces %}
{% if interface.pf_sync %}
### permit pfsync traffic
pass quick on ${{ interface.pf_macro }} proto pfsync keep state (no-sync)
{% endif %}
{% endfor %}

{% for interface in network_interfaces %}
{% if interface.pf_carp %}
pass quick on ${{ interface.pf_macro }} proto carp keep state (no-sync)
{% endif %}
{% endfor %}

### permit selected ICMP types on all interfaces
{% for interface in network_interfaces %}
pass quick on ${{ interface.pf_macro }} inet proto icmp all icmp-type { unreach, echoreq, timex }
pass quick on ${{ interface.pf_macro }} inet6 proto icmp6 all icmp6-type { echoreq, echorep, neighbradv, neighbrsol, routeradv, routersol, unreach, timex, paramprob }
pass in quick on ${{ interface.pf_macro }} inet6 proto icmp6 from { fe80::/10 ${{ interface.pf_macro }}:network } to ff02:0:0:0:0:1:ff00::/104 icmp6-type neighbrsol
{% endfor %}

{% if network_interfaces|length == 1 %}
{% for interface in network_interfaces %}
### this host is single homed, permit all outgoing traffic
pass out quick on ${{ interface.pf_macro }} from (${{ interface.pf_macro }})
{% endfor %}
{% endif %}

#######################################################
### GENERAL CUSTOMER VLAN RULES BELOW HERE

{% for interface in network_interfaces %}
## {{ interface.name }}
# interface debug: {{ interface }}
# Block all connections from this network to the firewall itself
block in quick on {{ interface.pf_macro }} from ({{ interface.pf_macro }}:network) to { {% for iface in network_interfaces %}({{ iface.pf_macro }}) {% endfor %}}
# Permit all other traffic from this interface
pass in quick on {{ interface.pf_macro }} {% if interface.route_to is defined %}route-to ({{ interface.route_to }}) {% endif %}from ({{ interface.pf_macro }}:network)
# Permit traffic from the firewall itself to this network
pass out quick on {{ interface.pf_macro }} from { {% for iface in network_interfaces %}({{ iface.pf_macro }}) {% endfor %}} to ({{ interface.pf_macro }}:network)

{% endfor %}

#######################################################
# CUSTOM FILTER RULES BELOW HERE

{% for rule in pf_filter_rules %}
# {{ rule.comment }}
{% if rule.block is defined %}block{% else %}pass{% endif %}
{% if rule.direction is defined %} {{ rule.direction }}{% endif %}
{% if not rule.slow is defined %} quick{% endif %}
{% if rule.block is defined or rule.log is defined %} log{% endif %}
{% if rule.interfaces is defined %} on { {{ rule.interfaces | join(" ") }} }{% endif %}
{% if rule.reply_to is defined %} reply-to ( {{ rule.reply_to }} ){% endif %}
{% if rule.inet is defined %} {{ rule.inet }}{% endif %}
{% if rule.protocols is defined %} proto { {{ rule.protocols | join(" ") }} }{% endif %}
{% if rule.sources is defined %} from { {{ rule.sources | join(" ") }} }{% endif %}
{% if rule.destinations is defined %} to { {{ rule.destinations | join(" ") }} }{% endif %}
{% if rule.ports is defined %} port { {{ rule.ports | join(" ") }} }{% endif %}
{% if rule.tag is defined %} tag {{ rule.tag }}{% endif %}
{% if rule.tagged is defined %} tagged {{ rule.tagged }}{% endif %}

{% endfor %}

