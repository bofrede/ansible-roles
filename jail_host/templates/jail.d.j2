# add this jail to the jail list
jail_list="$jail_list {{ jailname }}"

# hostname and jail root
jail_{{ jailname }}_hostname="{{ jail.hostname }}"
jail_{{ jailname }}_rootdir="{% if jail.root is defined %}jail.root{% else %}{{ jail_root }}/{{ jail.hostname }}{% endif %}"

{% if jail.devfs_ruleset is defined %}
# devfs
jail_{{ jailname }}_devfs_enable="YES"
jail_{{ jailname }}_devfs_ruleset="{{ jail.devfs_ruleset }}"

{% endif %}
{% if jail.parameters is defined %}
# custom jail parameters
jail_{{ jailname }}_parameters="{% for k,v in jail.parameters.items() %}{{ k }}={{ v }} {% endfor %}"

{% endif %}
# epair interface(s)
jail_{{ jailname }}_vnet_interface="{% for interface in jail.interfaces %}epair{{ interface.epair }}b {% endfor %}"

### prestart section (runs on host)
{% set x = 0 %}
{% for interface in jail.interfaces %}
jail_{{ jailname }}_exec_prestart{{ x }}="ifconfig epair{{ interface.epair }}a destroy 2>/dev/null || true"
jail_{{ jailname }}_exec_prestart{{ x + 1 }}="ifconfig epair{{ interface.epair }} create up"
jail_{{ jailname }}_exec_prestart{{ x + 2 }}="ifconfig epair{{ interface.epair }}a up description '{{ jail.hostname }} interface jail{{ loop.index0 }}'"
jail_{{ jailname }}_exec_prestart{{ x + 3 }}="ifconfig {{ interface.bridge }} addm epair{{ interface.epair }}a up"
{% set x = x + 4 %}
{% endfor %}

### start section (runs inside jail)
### not using emN because https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=260973
{% set ns = namespace(start=0) %}
{% set ns.start = 0 %}
{% for interface in jail.interfaces %}
{% set ifloop = loop %}
# interface jail{{ loop.index0 }}
jail_{{ jailname }}_exec_start{{ ns.start }}="ifconfig epair{{ interface.epair }}b name jail{{ ifloop.index0 }}"
{% if interface.ifconfig_inet is defined %}
# ipv4 for jail{{ loop.index0 }}
{% if interface.ifconfig_inet is string %}
{% set ns.start = ns.start + 1 %}
jail_{{ jailname }}_exec_start{{ ns.start }}="ifconfig jail{{ ifloop.index0 }} {{ interface.ifconfig_inet }}"
{% else %}
{% for ifconfig in interface.ifconfig_inet %}
{% set ns.start = ns.start + 1 %}
jail_{{ jailname }}_exec_start{{ ns.start }}="ifconfig jail{{ ifloop.index0 }} {{ ifconfig }}"
{% endfor %}
{% endif %}
{% endif %}
{% if interface.ifconfig_inet6 is defined %}
# ipv6 for jail{{ loop.index0 }}
{% if interface.ifconfig_inet6 is string %}
{% set ns.start = ns.start + 1 %}
jail_{{ jailname }}_exec_start{{ ns.start }}="ifconfig jail{{ ifloop.index0 }} inet6 {{ interface.ifconfig_inet6 }}"
{% else %}
{% for ifconfig in interface.ifconfig_inet6 %}
{% set ns.start = ns.start + 1 %}
jail_{{ jailname }}_exec_start{{ ns.start }}="ifconfig jail{{ ifloop.index0 }} inet6 {{ ifconfig }}"
{% endfor %}
{% endif %}
{% endif %}

{% endfor %}

# static routes
{% for route in jail.routes %}
{% set ns.start = ns.start + 1 %}
jail_{{ jailname }}_exec_start{{ ns.start }}="route add {{ route }}"
{% endfor %}


### poststop section (runs on host)
{% for interface in jail.interfaces %}
jail_{{ jailname }}_exec_poststop{{ loop.index0 }}="ifconfig {{ interface.bridge }} deletem epair{{ interface.epair }}a && ifconfig epair{{ interface.epair }}a destroy"
{% endfor %}
